<!-- 状态栏 -->
<view class="status-bar">
  <view class="status-row1">
    <view class="status-left">
      <button class="exit-btn" bindtap="exitGame">退出</button>
    </view>
    <view class="status-right">
      <view class="triple">
        <text class="lt">{{levelType}}</text>
        <text class="mid">底注:{{currentBet}}/{{targetBet}}</text>
        <text class="rt">回合:{{currentRound}}</text>
      </view>
    </view>
  </view>
  <view class="status-row2">
    <button class="control-btn info-btn" bindtap="showInfo">牌型</button>
    <button class="control-btn bag-btn" bindtap="openBag">背包</button>
    <button class="control-btn deck-btn" bindtap="showDeck">{{remainCards}}/{{totalCards}}</button>
  </view>

  <!-- 背包覆盖层 -->
  <view class="bag-overlay" wx:if="{{showBagPanel}}">
    <view class="bag-panel">
      <view class="bag-header">
        <text class="gold-in-bag">🥮{{gold}}</text>
        <text class="bag-title">背包 - 星球牌</text>
        <button class="close-btn" bindtap="closeBag">×</button>
      </view>
      <view class="bag-toolbar-row1">
        <button class="toggle-select-btn" bindtap="toggleSelectAll">{{isAllSelected ? '取消全选' : '全选'}}</button>
      </view>
      <view class="bag-toolbar-row2">
        <button class="use-btn" wx:if="{{selectedCount>0}}" bindtap="useSelectedPlanet">使用</button>
        <button class="sell-btn" wx:if="{{selectedCount>0}}" bindtap="sellSelectedPlanet">售出(<text class="gold-text">🥮{{selectedCount}}</text>)</button>
      </view>
      <view class="bag-grid">
        <block wx:for="{{9}}" wx:key="index">
          <view class="bag-slot{{bagItems[index] ? ' has-item' : ''}}">
            <view wx:if="{{bagItems[index]}}" class="bag-planet{{bagItems[index].__selected?' selected':''}}" data-index="{{index}}" bindtap="toggleSelectOne">
              <view class="planet-inner small">
                <text class="planet-type">{{bagItems[index].type}}</text>
                <text class="planet-level">{{bagItems[index].level || 1}}</text>
              </view>
            </view>
            <view wx:else class="bag-slot-empty"></view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <view class="status-row3">
    <text>目标:{{scoreTarget}}</text>
    <text>出牌:{{remainPlay}}</text>
    <text>弃牌:{{remainDiscard}}</text>
  </view>
  <view class="status-row4">
    <view class="row-left">
      <text>回合分数: {{roundScore}}</text>
    </view>
    <view class="row-right" wx:if="{{cardType && cardType !== ''}}">
      <view class="card-type-info">
        <text class="normal-style">{{cardType}}</text>
        <text class="shadow-style">等级{{cardGrade}}</text>
        <text class="count-hash">#</text><text class="count-orange">{{cardCount}}</text>
      </view>
    </view>
  </view>
  <view class="status-row5">
    <view class="row-left">
      <text class="gold-text">🥮{{gold}}</text>
    </view>
    <view class="row-right" wx:if="{{cardType && cardType !== ''}}">
      <text class="chip-label">{{currentChip}}</text>
      <text class="multiply-label">×</text>
      <text class="multiplier-label">{{currentMultiplier}}</text>
      <text class="equals-label">=</text>
      <text class="product-label">{{currentChip * currentMultiplier}}</text>
    </view>
  </view>
  <view class="status-row6">
  </view>
</view>

<!-- 小丑牌区 -->
<joker-strip id="joker-strip" jokers="{{jokerCards}}" maxSlots="7" abstractJokerBonus="{{abstractJokerBonus}}" tapEnabled="{{true}}" alignMode="left" bind:tap="showJokerDetailFromStrip" />

<!-- 小丑牌详情弹框 -->
<view class="joker-detail-overlay" wx:if="{{showJokerDetail}}">
  <view class="joker-detail-panel">
    <view class="joker-detail-header">
      <text class="joker-detail-title">{{currentJoker.name}}</text>
      <button class="close-btn" bindtap="closeJokerDetail">×</button>
    </view>
    <view class="joker-detail-content">
      <view class="joker-detail-rarity" style="background-color: {{currentJoker.backgroundColor}}; color: {{currentJoker.textColor}};">
        {{currentJoker.rarity}}
      </view>
      <view class="joker-detail-effect">
        {{currentJoker.effect}}
      </view>
    </view>
    <view class="joker-detail-footer">
      <button class="sell-joker-btn" bindtap="sellJoker">
        出售(<text class="gold-text">🥮{{currentJoker.sellPrice}}</text>)
      </button>
    </view>
  </view>
</view>

<!-- 出牌区 -->
<view class="played-area">
  <block wx:for="{{5|range}}" wx:for-index="idx" wx:key="idx">
    <view class="played-card{{scoreCards[idx].isValid ? ' valid-card' : ''}}{{scoreCards[idx].colorState ? ' ' + scoreCards[idx].colorState : ''}}" wx:if="{{scoreCards[idx]}}" data-index="{{idx}}">
      <view class="card-content">
        <view class="card-suit">{{scoreCards[idx].suit}}</view>
        <view class="card-point">{{scoreCards[idx].point}}</view>
      </view>
      <view class="debug-info" style="font-size: 8rpx; color: red;">{{scoreCards[idx].isValid ? 'V' : 'X'}}</view>
    </view>
    <view class="played-card-back" wx:else></view>
  </block>
</view>

<!-- 操作按钮区 -->
<view class="action-btns">
  <button class="play-btn{{!hasSelectedCards ? ' disabled' : ''}}" bindtap="playCard" disabled="{{!hasSelectedCards}}">出牌</button>
  <button class="point-btn" bindtap="sortByPoint">
    <view class="indicator{{sortMode === 'point' ? ' active' : ''}}"></view>
    点数
  </button>
  <button class="suit-btn" bindtap="sortBySuit">
    <view class="indicator{{sortMode === 'suit' ? ' active' : ''}}"></view>
    花色
  </button>
  <button class="discard-btn{{(!hasSelectedCards || remainDiscard <= 0) ? ' disabled' : ''}}" bindtap="discardCard" disabled="{{!hasSelectedCards || remainDiscard <= 0}}">弃牌</button>
</view>

<!-- 手牌区：6行5列共30个蓝色条纹背面卡牌 -->
<view class="hand-area-outer">
  <view class="hand-count">{{currentHandCount}}/{{handLimit}}</view>
  <view class="hand-area">
    <block wx:for="{{4|range}}" wx:for-index="rowIdx" wx:key="rowIdx">
      <view class="hand-row">
        <block wx:for="{{7|range}}" wx:for-index="slotIdx" wx:key="slotIdx">
          <block wx:if="{{handRows[rowIdx][slotIdx] && handRows[rowIdx][slotIdx].back}}">
            <view class="hand-card-back"></view>
          </block>
          <block wx:elif="{{handRows[rowIdx][slotIdx] && handRows[rowIdx][slotIdx].suit}}">
            <view class="hand-card{{selectedCards[rowIdx][slotIdx] ? ' selected' : ''}}" bindtap="onCardBackTap" data-rowidx="{{rowIdx}}" data-slotidx="{{slotIdx}}">
              <view class="card-content">
                <view class="card-suit">{{handRows[rowIdx][slotIdx].suit}}</view>
                <view class="card-point">{{handRows[rowIdx][slotIdx].point}}</view>
              </view>
            </view>
          </block>
          <block wx:else>
            <view class="hand-card-back"></view>
          </block>
        </block>
      </view>
    </block>
  </view>
</view>

<!-- 结算面板 -->
<view class="settlement-panel" wx:if="{{showSettlement}}">
  <view class="settlement-content">
    <view class="settlement-title">回合胜利！</view>
    <view class="settlement-info">
      <text>回合分数: {{roundScore}}</text>
      <text>目标分数: {{scoreTarget}}</text>
      <text>通关奖励: <text class="gold-text">🥮{{levelReward}}</text></text>
      <text>速胜奖励: <text class="gold-text">🥮{{remainPlay}}</text></text>
      <text>利息: <text class="gold-text">🥮{{interest}}</text></text>
      <text>获得金币: <text class="gold-text">🥮{{totalReward}}</text></text>
    </view>
    <view class="settlement-buttons">
      <button class="shop-btn" bindtap="enterShop">进入商店</button>
    </view>
  </view>
</view>

<!-- 比赛信息覆盖层 -->
<view class="info-overlay" wx:if="{{showInfoPanel}}">
  <view class="info-panel">
    <view class="info-header">
      <text class="panel-title">牌型</text>
      <button class="close-btn" bindtap="closeInfo">×</button>
    </view>
    <view class="info-body">
      <view class="info-table">
        <block wx:for="{{infoTypeRows}}" wx:key="type">
          <view class="info-row">
            <text class="col-level">{{item.level}}</text>
            <text class="col-type">{{item.type}}</text>
            <view class="col-product">
              <text class="chip-label">{{item.chip}}</text>
              <text class="multiply-x">✖️</text>
              <text class="multiplier-label">{{item.multiplier}}</text>
            </view>
            <text class="col-count"><text class="count-hash">#</text><text class="count-orange">{{item.playCount}}</text></text>
          </view>
        </block>
      </view>
    </view>
  </view>
</view>

<!-- 牌组图层 -->
<view class="deck-overlay" wx:if="{{showDeckPanel}}">
  <view class="deck-panel">
    <view class="deck-header">
      <text class="panel-title">牌组</text>
      <button class="close-btn" bindtap="closeDeck">×</button>
    </view>
    <view class="deck-body">
      <view class="deck-grid">
        <block wx:for="{{deckDisplay}}" wx:key="point">
          <view class="deck-row">
            <text class="deck-point-label">{{item.point}}</text>
            <view class="deck-cards">
              <block wx:for="{{item.cards}}" wx:key="index" wx:for-item="card">
                <view class="deck-card {{card.status}}" style="z-index: {{index}};">
                  <view class="deck-card-content">
                    <view class="deck-card-suit">{{card.suit}}</view>
                    <view class="deck-card-point">{{card.point}}</view>
                  </view>
                </view>
              </block>
            </view>
          </view>
        </block>
      </view>
    </view>
  </view>
</view> 